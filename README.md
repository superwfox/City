# City - 中文说明文档 [[English Version Documention](https://github.com/superwfox/City/blob/master/README_EN.md)]

一个专为 **Mohist 1.20.1** 混合端编写的每日重置城市生存核心插件  
（本插件仅在 Mohist 1.20.1 上进行过完整的三天压力测试与功能验证，其他版本未作保证）

## 插件指令列表 （所有指令默认仅 OP 可用）

| 指令                  | 参数                  | 功能说明                                      |
|-----------------------|-----------------------|-----------------------------------------------|
| `/city save`          | 无                    | 将玩家当前所在区块标记为安全区（重置后保留）   |
| `/city cancel`        | 无                    | 取消当前区块的安全区保护                      |
| `/city rewards`       | `[页码，可选]`        | 打开全局奖励池编辑界面（54 格，支持分页）      |
| `/city add`           | 无（需对准方块）      | 将对准的方块注册为奖励箱（自动变为箱子）       |
| `/city remove`        | 无（需对准奖励箱）    | 删除对准的奖励箱                               |
| `/city allchest`      | 无                    | 列出所有奖励箱坐标并提供点击传送               |
| `/city check`         | 无                    | 手动进入城市维度（坐标映射到模板世界）         |
| `/city back`          | 无                    | 返回上次进入城市维度前的位置                   |
| `/city reload`        | 无                    | 手动触发世界完整重置 + 重载配置 + 清空已开箱记录 |

> 所有指令均由 `plugin.yml` 控制权限，默认仅限 OP 执行

## 功能详解

### 1. 每日自动重置
- 每天凌晨 4 点整，插件会自动删除 City-World ,过程实现热重载，无需关闭服务器。
- 重置前会自动把所有安全区区块写回模板世界，保证建筑不丢失。
- 重置过程中在线玩家会被暂时踢出，完成后即可正常进入。

### 2. 安全区（区块保留）
- 使用 `/city save` 站在想保护的区块中间执行，即可把整个 16×16 区块标记为安全区。
- 使用 `/city cancel` 可取消当前区块的保护。
- 每次重置时，插件会把所有标记为安全区的区块完整复制回模板世界，下次重置后仍然保留。
- 数据保存在插件文件夹下的 `saveZone.txt`（每行一个 `chunkX,chunkZ`）。

### 3. 奖励箱系统
- 管理员用 `/city add` 对准任意方块 → 该位置会被注册为奖励箱（会自动变成箱子）。
- 用 `/city remove` 对准已注册的奖励箱即可删除。
- 玩家每次进入已加载的区块时，注册过的奖励箱会自动生成。
- 每位玩家对每一个奖励箱只能开启一次（已开启记录会一直保留到下次手动 `/city reload`）。
- 箱子内物品按照 config.yml 中的概率值，从全局奖池中随机抽取填入 27 格。
- 所有奖励箱坐标保存在 `chestLocs.txt`。

### 4. 全局奖池管理 GUI
- 执行 `/city rewards`（可带页码）打开 54 格编辑界面。
- 直接把物品拖进去或修改现有物品，关闭界面后自动保存。
- 支持无限数量物品，超出 54 格会自动分页。
- 数据以 Base64 形式保存在 `rewards.txt`。

### 5. 城市维度生物数量限制
- config.yml 中的 `城市维度.刷怪上限` 控制 City-World 同时存在的生物总数（根据玩家单独限制刷怪数量）。
- 超过上限后新刷出的怪物会被直接取消，防止后期怪物堆积卡服。

### 6. 维度传送逻辑
- 从主世界用下界传送门进入 → 随机传送到某一个安全区区块的中心最高处。
- 如果还没有设置任何安全区，默认传送到 0,0 区块。
- 从城市世界返回主世界 → 自动回到进入前的坐标（或床点/出生点）。
- 执行 `/city check` 可手动进入城市世界（会把主世界坐标映射到模板世界对应位置）。
- 执行 `/city back` 随时返回上次进入前的位置。

### 7. 其他实用命令
- `/city allchest` → 列出所有已注册奖励箱坐标，点击即可传送。
- `/city reload` → 手动触发一次完整重置 + 重读所有配置文件 + 清空已开启奖励箱记录。

## 配置文件（plugins/City/config.yml）
```yaml
奖励箱概率.概率值: 500        # 1-1000，数值越大每个格子出物品概率越高（500 ≈ 50%）
城市维度.玩家刷怪上限: 500       # 城市世界最大生物数量，建议 300-800
```

## 文件说明
` - 位于插件文件夹 ：`
- `saveZone.txt` → 安全区区块坐标
- `chestLocs.txt` → 奖励箱位置（格式：区块X,区块Z,箱子相对X,Y,Z）
- `rewards.txt` → Base64 编码的完整奖池列表

` - 位于根目录 ：`
- `Template-World` → 永久模板世界（虚空平坦），请勿手动删除
- `City-World` → 城市维度，每天会被重建

## 权限与使用对象
所有 `/city` 子命令默认仅 OP 可用（由 plugin.yml 控制）。

## 测试环境
- Mohist 1.20.1（官方最新 Build `mohist-1.20.1-6eb4f67`）
- 纯净环境，三天连续重置 72 次，无任何崩溃与数据丢失

如需适配其他版本或增加新功能，可联系作者 @SudarkX。  
感谢使用！
