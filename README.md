# City 插件

## 项目描述

**City** 是一个专为 Minecraft Mohist 服务器设计的插件，用于管理一个独立的“城市世界”（City-World）。该插件支持世界定时重置、安全区域保护、奖励箱系统、实体生成限制、门户传送管理以及传送和编辑命令。主要功能包括：

- 自动重置城市世界（默认每天凌晨 4:00）。
- 保护指定区块作为安全区域，避免重置时丢失建筑。
- 在指定位置生成奖励箱，玩家打开时随机填充战利品。
- 限制城市世界中实体生成数量（最多 5 个实体同时存在）。
- 自动管理主世界与城市世界之间的门户传送。
- 提供 `/city` 命令来管理安全区域、奖励和传送。

插件基于 Bukkit API 开发，适用于 1.19+ 版本的服务器。主类为 `City.java`。

## 特性

- **世界管理**：
  - 创建并管理模板世界（Template-World）和城市世界（City-World）。
  - 定时重置城市世界，同时保存安全区域的区块到模板世界。
  
- **安全区域系统**：
  - 标记区块为安全区域，重置时自动备份。
  - 支持添加/移除安全区域。

- **奖励系统**：
  - 在指定区块生成奖励箱（Chest）。
  - 玩家打开奖励箱时，根据配置概率随机填充物品。
  - 支持通过 GUI 编辑和管理奖励物品列表。

- **实体管理**：
  - 在城市世界中限制实体生成，最多允许 5 个实体同时存在，以防止拥挤和性能问题。

- **门户管理**：
  - 自动处理主世界与城市世界之间的门户旅行。
  - 从城市世界离开：传送回主世界的出生点。
  - 进入城市世界：随机传送至安全区域区块的中心位置。

- **命令系统**：
  - 统一的 `/city` 命令，支持子命令如 `save`、`rewards`、`add` 等。
  - 传送功能：返回主世界或合理位置。

- **文件持久化**：
  - 自动保存奖励物品、安全区域和奖励箱位置到 YAML/文本文件。
  - 支持重载配置。

## 先决条件

- Minecraft 服务器运行 Bukkit/Spigot/Paper（推荐 1.19+ 版本）。
- Java 17+ 环境。
- 确保服务器的 `server.properties` 中的 `level-name` 与插件兼容（插件会自动读取）。

## 安装

1. **下载插件**：
   - 从 [Releases](https://github.com/yourusername/city-plugin/releases) 下载最新的 `City.jar` 文件（如果这是开源项目；否则自行编译）。

2. **放置文件**：
   - 将 `City.jar` 复制到服务器的 `plugins/` 文件夹中。

3. **重启服务器**：
   - 重启服务器以加载插件。
   - 插件会自动创建 `plugins/City/` 文件夹，并生成必要的文件（如 `config.yml`、`saveZone.txt` 等）。

4. **验证安装**：
   - 在服务器控制台查看日志，确保无错误（如 "已重载配置文件"）。
   - 进入游戏，使用 `/city` 检查命令是否可用。

## 配置

插件的主要配置文件位于 `plugins/City/config.yml`。默认配置如下：

```yaml
奖励箱概率:
  概率值: 500  # 概率值（1-1000），默认 500（每个槽位 50% 几率生成物品）
  类型: "正整数 [1-1000]"
  作用: "控制奖励箱每个槽位有多大概率刷出物品"
  计算公式: "概率值 / 1000"
```

- **修改配置**：
  - 编辑 `config.yml` 中的 `概率值`（范围 1-1000，超出将重置为 500）。
  - 保存后，使用 `/city reload` 重载配置（同时重置世界）。

- **其他文件**：
  - `rewards.txt`：存储序列化的奖励物品列表（Base64 编码）。
  - `chestLocs.txt`：奖励箱位置（格式：`chunkX,chunkZ,blockX,blockY,blockZ`）。
  - `saveZone.txt`：安全区域区块（格式：`chunkX,chunkZ`）。

## 命令

所有命令前缀为 `/city`，需要 OP 权限或 `city.admin` 权限（默认 OP）。

| 子命令 | 描述 | 用法示例 |
|--------|------|----------|
| `save` | 将当前区块添加到安全区域（重置时保护）。 | `/city save` |
| `cancel` | 从安全区域移除当前区块。 | `/city cancel` |
| `rewards [页码]` | 打开奖励物品管理界面（分页，页码可选，从 0 开始）。 | `/city rewards 1` |
| `list` | 在聊天中列出所有奖励物品。 | `/city list` |
| `add` | 在注视的方块位置添加奖励箱（覆盖同区块旧箱）。 | `/city add` |
| `remove` | 移除注视的奖励箱。 | `/city remove` |
| `allchest` | 列出所有奖励箱位置，并提供点击传送链接。 | `/city allchest` |
| `check` | 传送到模板世界中的合理位置（用于预览建筑）。 | `/city check` |
| `back` | 返回主世界（床点或出生点）。 | `/city back` |
| `reload` | 重置世界并重载所有配置/文件。 | `/city reload` |

### 奖励管理界面
- 在奖励 GUI 中：
  - 将物品放入槽位编辑奖励列表。
  - 关闭界面自动保存。
  - 支持分页（每页 54 物品，最后一页用 `/city rewards -1`）。

## 使用指南

### 1. 设置安全区域
- 前往要保护的区块，使用 `/city save` 添加。
- 重置世界时，这些区块会从当前城市世界复制到模板世界，并在新世界中恢复。

### 2. 添加奖励箱
- 使用 `/city add` 在注视位置放置胸作为奖励箱。
- 编辑奖励物品：使用 `/city rewards` 打开 GUI，放入物品并关闭保存。
- 玩家进入区块时，胸自动生成；打开时填充随机奖励（基于概率）。

### 3. 世界重置
- 默认每天凌晨 4:00 自动重置（通过 `Clock.java` 调度）。
- 重置前会踢出玩家并保存安全区域。
- 重置后，城市世界会从模板复制结构。

### 4. 传送与预览
- `/city check`：传送到模板世界的对应位置，预览建筑。
- `/city back`：安全返回主世界。
- 门户传送：自动管理——从主世界进入随机至安全区域；从城市世界离开至出生点。

### 5. 实体限制
- 在城市世界中，同时最多允许 5 个实体生成，以维护性能并防止混乱。

## 已知问题与注意事项

- **性能**：重置大型世界时可能导致延迟，确保服务器有足够资源。
- **兼容性**：插件使用 Bukkit API，未测试与其他世界管理插件的兼容。
- **奖励序列化**：使用 Base64 编码物品，确保物品类型兼容 Bukkit 版本。
- **日志**：IO 错误会打印到控制台，检查 `latest.log` 以调试。
- **多世界**：确保主世界名称正确（从 `server.properties` 读取）。

## 贡献

欢迎提交 Issue 或 Pull Request！如果您有新特性建议（如自定义重置时间），请在 GitHub 上讨论。

1. Fork 项目。
2. 创建分支 `feature/xxx`。
3. 提交 PR。

## 许可证

此项目使用 MIT 许可证。详见 [LICENSE](LICENSE) 文件。

## 联系

- 作者：Sudark
- 问题反馈：GitHub Issues 或 Discord（如果有）。

---

*最后更新：2025-11-17*  
感谢使用 City 插件！如果有任何问题，欢迎反馈。
